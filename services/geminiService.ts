import { GoogleGenAI, Type } from "@google/genai";

// Fix: Always use named parameter for apiKey and obtain directly from process.env.API_KEY
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const parseOrderText = async (text: string): Promise<any> => {
  const prompt = `
    You are a smart procurement assistant. Analyze the following Chinese or English text which describes a procurement order.
    Extract the following details:
    - itemName: The name of the product (Keep it concise, translate to Chinese if mixed).
    - quantity: Number of items (number).
    - priceUSD: Price per unit in USD (number).
    - buyerAddress: The full shipping address including name and phone if available.
    - platform: The buying platform (e.g. Amazon, Taobao, 1688).
    - platformOrderId: The order ID generated by the buying platform (e.g. Amazon order number like 114-1234567-1234567), if present.
    - clientOrderId: The client's reference number or internal order ID if mentioned (e.g. "客户单号: ABC-123").
    
    If a field is missing, make a reasonable guess based on context or leave it null.
    
    Example Input: "客户单号 ORD-2024-001，帮我买5个iPhone 15手机壳，发到深圳市...，亚马逊买，订单号是 112-3333333-4444444"
    Example Output JSON: {"itemName": "iPhone 15手机壳", "quantity": 5, "priceUSD": 0, "buyerAddress": "...", "platform": "Amazon", "platformOrderId": "112-3333333-4444444", "clientOrderId": "ORD-2024-001"}
  `;

  try {
    // Fix: Use gemini-3-pro-preview for complex reasoning/extraction tasks
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: {
        parts: [
           { text: prompt },
           { text: `Input text to parse: "${text}"` }
        ]
      },
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            itemName: { type: Type.STRING },
            quantity: { type: Type.NUMBER },
            priceUSD: { type: Type.NUMBER },
            buyerAddress: { type: Type.STRING },
            platform: { type: Type.STRING },
            platformOrderId: { type: Type.STRING },
            clientOrderId: { type: Type.STRING },
          }
        }
      }
    });
    
    if (response.text) {
        return JSON.parse(response.text);
    }
    return null;
  } catch (error) {
    console.error("Gemini Parse Error:", error);
    throw error;
  }
};

export const parseOrderImage = async (base64Image: string): Promise<any> => {
    // Remove header if present (e.g., "data:image/png;base64,")
    const base64Data = base64Image.split(',')[1] || base64Image;

    const prompt = `
      Analyze this image of a product order, shopping cart, or chat log.
      Extract the order details into JSON format.
      - itemName: Product name.
      - quantity: Quantity.
      - priceUSD: Price in USD (if symbol is ¥/RMB, convert approx or keep number).
      - buyerAddress: Address if visible.
      - platform: Platform name (Amazon, eBay, etc) if recognizable.
      - platformOrderId: Order ID if visible.
      - clientOrderId: Client/Customer Order ID if visible.
    `;

    try {
        // Fix: Use gemini-3-flash-preview for high-performance multimodal understanding
        const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: {
                parts: [
                    { text: prompt },
                    { 
                        inlineData: {
                            mimeType: "image/jpeg", 
                            data: base64Data
                        }
                    }
                ]
            },
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        itemName: { type: Type.STRING },
                        quantity: { type: Type.NUMBER },
                        priceUSD: { type: Type.NUMBER },
                        buyerAddress: { type: Type.STRING },
                        platform: { type: Type.STRING },
                        platformOrderId: { type: Type.STRING },
                        clientOrderId: { type: Type.STRING },
                    }
                }
            }
        });

        if (response.text) {
            return JSON.parse(response.text);
        }
        return null;
    } catch (error) {
        console.error("Gemini Image Parse Error:", error);
        throw error;
    }
};

export const generateStatusUpdate = async (order: any): Promise<string> => {
    const prompt = `
      Create a polite notification message in Chinese to the customer about their order status.
      
      Order Details:
      Item: ${order.itemName}
      Current Status: ${order.status}
      Tracking Number: ${order.trackingNumber || 'Not available yet'}
      Order Ref: ${order.clientOrderId || ''}
      
      The tone should be professional and reassuring.
      Only return the message content.
    `;

    try {
        // Fix: Use gemini-3-flash-preview for basic text generation tasks
        const response = await ai.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: prompt
        });
        return response.text || "Could not generate message.";
    } catch (e) {
        console.error(e);
        return "Error generating message.";
    }
};

export const parseNaturalLanguageSearch = async (query: string): Promise<any> => {
  const prompt = `
    You are a data query parser. Convert this natural language search query for a procurement order system into a JSON filter object.
    
    Current Date: ${new Date().toISOString().split('T')[0]}
    
    Input Query: "${query}"

    Instructions:
    1. Dates: Convert relative dates (e.g., "last week", "上周", "三天前") to ISO YYYY-MM-DD strings for startDate/endDate.
    2. Platforms: Identify e-commerce platforms (Amazon, Ali, Taobao, 1688, etc.).
    3. Status Mapping (CRITICAL):
       - "Pending", "代采购", "没买" -> 'Pending'
       - "Purchased", "已采购", "买了", "未发货" -> 'Purchased'
       - "Ready to Ship", "待发货", "入库", "到仓库" -> 'Ready to Ship'
       - "Shipped", "已发货", "路上", "运输中" -> 'Shipped'
       - "Delivered", "已签收", "到了" -> 'Delivered'
       - "Cancelled", "取消", "不要了" -> 'Cancelled'
       - "Delayed", "超时", "晚了", "异常" -> 'delayed'
    4. Keywords: Anything else (product name, address, order ID) goes to 'keyword'.
    
    Output JSON Schema:
    {
       startDate: string | null,
       endDate: string | null,
       platform: string | null,
       status: 'Pending' | 'Purchased' | 'Ready to Ship' | 'Shipped' | 'Delivered' | 'Cancelled' | 'delayed' | null,
       minPrice: number | null,
       maxPrice: number | null,
       keyword: string | null
    }
  `;

  try {
     // Fix: Use gemini-3-pro-preview for advanced reasoning and parsing tasks
     const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
         responseSchema: {
          type: Type.OBJECT,
          properties: {
            startDate: { type: Type.STRING, nullable: true },
            endDate: { type: Type.STRING, nullable: true },
            platform: { type: Type.STRING, nullable: true },
            status: { type: Type.STRING, nullable: true },
            minPrice: { type: Type.NUMBER, nullable: true },
            maxPrice: { type: Type.NUMBER, nullable: true },
            keyword: { type: Type.STRING, nullable: true },
          }
        }
      }
    });

    if (response.text) {
        return JSON.parse(response.text);
    }
    return null;
  } catch (error) {
      console.error("Gemini Search Parse Error", error);
      return null;
  }
};